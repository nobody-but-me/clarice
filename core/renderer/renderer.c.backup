
#include <string.h>
#include <stdio.h>

#include <renderer/renderer.h>
#include <cglm/cglm.h>

#include <common/data.h>
#include <libs/glad.h>
#include <GLFW/glfw3.h>

#define MOLSON_IMPLEMENTATION
#include <libs/molson.h>

static int check_gl_errors()
{
	GLenum err=glGetError();
	if((err==glGetError())!=GL_NO_ERROR)
	{
		if((err==GL_NO_ERROR))
			return 0;
		char*error_message;
		if(err==GL_INVALID_FRAMEBUFFER_OPERATION)
			error_message="invalid framebuffer operation.";
		else if(err==GL_INVALID_OPERATION)
			error_message="invalid operation.";
		else if(err==GL_STACK_UNDERFLOW)
			error_message="stack underflow.";
		else if(err==GL_STACK_OVERFLOW)
			error_message="stack overflow.";
		else if(err==GL_INVALID_VALUE)
			error_message="invalid value";
		else if(err==GL_OUT_OF_MEMORY)
			error_message="out of memory.";
		else if(err==GL_INVALID_ENUM)
			error_message="invalid enum";
		fprintf(stderr,"renderer.c::check_gl_errors() : %s.\n",error_message);
		return 1;
	}
	return 0;
}

unsigned int g_quad_vao=0;
unsigned int g_quad_vbo=0;
Shader*g_main_object_shader;

void renderer(get_quad_vao)(unsigned int*vao_)
{
	vao_=&g_quad_vao;
	return;
}
void renderer(get_quad_vbo)(unsigned int*vbo_)
{
	vbo_=&g_quad_vbo;
	return;
}

int renderer(init_globals)(void)
{
	glGenVertexArrays(1,&g_quad_vao);
	glBindVertexArray(g_quad_vao);
	glGenBuffers(1,&g_quad_vbo);
	
	glBindBuffer(GL_ARRAY_BUFFER,g_quad_vbo);
	glBufferData(GL_ARRAY_BUFFER,sizeof(RECT_VERTEX_DATA),RECT_VERTEX_DATA,GL_STATIC_DRAW);
	
	glVertexAttribPointer(0,3,GL_FLOAT,GL_FALSE,5*sizeof(float),(void*)0);
	glEnableVertexAttribArray(0);
	glVertexAttribPointer(1,2,GL_FLOAT,GL_FALSE,5*sizeof(float),(void*)(3*sizeof(float)));
	glEnableVertexAttribArray(1);
	
	glBindBuffer(GL_ARRAY_BUFFER,0);
	glBindVertexArray(0);
	return check_gl_errors();
}

int renderer(init_rect)(object*object_,texture*texture_,const char*name_)
{
	object_->m_type=quad_object;
	object_->name=strcpy(name_);
	
	if(texture!=NULL)
		object_->m_texture=texture_;
	else
		object_->m_texture=NULL;
	object->m_initialized=1;
	return;
}

int renderer(set_object_transform)(object*object_)
{
	molson(use_shader)(g_main_object_shader);
	mat4 transform=GLM_MAT4_IDENTITY_INIT;
	glm_translate(transform,(vec3){object})
}

